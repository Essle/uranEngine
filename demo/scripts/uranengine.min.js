/* uranEngine v1.0 / www.uranengine.ru */
function _element(e){this.name=e;this.id=(new Date).getTime();this.data={collision:[]};this.property={attach:false,sprite:null,health:100,collision:false,speed:2,polygons:[],offset:{left:{min:0,max:0},top:{min:0,max:0}},position:{left:0,top:0},size:{height:0,width:0},data:[]};OBJECTS[OBJECTS.length]=this}function __isObjectCollision(e,t){var n=false;for(var r in OBJECTS){if(!e.has()){return true}if(e==OBJECTS[r]||OBJECTS[r].name=="Map"){continue}if(__isPositionInObject(t,OBJECTS[r],e)){if(OBJECTS[r].property.collision){n=true}if(!e.data.collision[OBJECTS[r].id]){e.data.collision[OBJECTS[r].id]=true;if(!OBJECTS[r].property.collision){EVENTS["enter"].call(e,{object:e,collision:OBJECTS[r]})}EVENTS["collision"].call(e,{object:e,collision:OBJECTS[r]})}}else{if(e.data.collision[OBJECTS[r].id]){delete e.data.collision[OBJECTS[r].id];if(!OBJECTS[r].property.collision){EVENTS["leave"].call(e,{object:e,collision:OBJECTS[r]})}}}}return n}function __getObjectOffset(e,t){if(!t){t=e.property.position}return{left:{min:t.left-e.property.size.width/2,max:t.left+e.property.size.width/2},top:{min:t.top-e.property.size.height/2,max:t.top+e.property.size.height/2}}}function __isPositionInObject(e,t,n){function r(e,t,n){var r=false;var i=__getObjectOffset(n);for(var s=0,o=n.property.polygons.length-1;s<n.property.polygons.length;o=s++){var u=i.left.min+n.property.polygons[s][0],a=i.top.min+n.property.polygons[s][1],f=i.left.min+n.property.polygons[o][0],l=i.top.min+n.property.polygons[o][1];if(a>t!=l>t&&e<(f-u)*(t-a)/(l-a)+u){r=!r}}return r}if(n){var i=__getObjectOffset(n);for(var s=0;s<n.property.polygons.length;++s){var o=i.left.min+n.property.polygons[s][0],u=i.top.min+n.property.polygons[s][1];if(r(o,u,t)){return true}}}else{return r(e.left,e.top,t)}return false}function onDeath(e,t){EVENTS["death"].addCallback(e,t)}function onCollision(e,t){EVENTS["collision"].addCallback(e,t)}function onMove(e,t){EVENTS["move"].addCallback(e,t)}function onEnter(e,t){EVENTS["enter"].addCallback(e,t)}function onLeave(e,t){EVENTS["leave"].addCallback(e,t)}function createWorld(e,t,n){window.onload=function(){WORLD.element=document.getElementById(e);WORLD.canvas=WORLD.element.getContext("2d");WORLD.element.width=t[0];WORLD.element.height=t[1];WORLD.canvas.textBaseline="middle";(function r(){requestAnimFrame(r);__updateWorld()})();n()}}function __updateWorld(){WORLD.canvas.clearRect(0,0,WORLD.element.width,WORLD.element.height);for(var e in OBJECTS){if(!OBJECTS[e].isVisible()){continue}if(OBJECTS[e].property.sprite){WORLD.canvas.drawImage(OBJECTS[e].property.sprite,0,0,OBJECTS[e].property.size.width,OBJECTS[e].property.size.height,OBJECTS[e].property.position.left-OBJECTS[e].property.size.width/2,OBJECTS[e].property.position.top-OBJECTS[e].property.size.height/2,OBJECTS[e].property.size.width,OBJECTS[e].property.size.height)}else if(OBJECTS[e].property.polygons.length>2){var t=OBJECTS[e].property.polygons,n=__getObjectOffset(OBJECTS[e]);WORLD.canvas.beginPath();WORLD.canvas.lineWidth=1;WORLD.canvas.strokeStyle="#ff0000";for(var r=0;r<t.length-1;++r){WORLD.canvas.moveTo(n.left.min+t[r][0],n.top.min+t[r][1]);WORLD.canvas.lineTo(n.left.min+t[r+1][0],n.top.min+t[r+1][1])}WORLD.canvas.moveTo(n.left.min+t[t.length-1][0],n.top.min+t[t.length-1][1]);WORLD.canvas.lineTo(n.left.min+t[0][0],n.top.min+t[0][1]);WORLD.canvas.stroke()}}for(var e in HUD){if(!HUD[e].text.length||!HUD[e].property.toggle){continue}WORLD.canvas.textAlign=HUD[e].property.align;WORLD.canvas.fillStyle=HUD[e].property.color;WORLD.canvas.font=(HUD[e].property.bold?"bold ":"")+HUD[e].property.size+"px "+HUD[e].property.font;WORLD.canvas.fillText(HUD[e].text,HUD[e].property.position.left,HUD[e].property.position.top)}for(var i in keyController.has){if(keyController.has[i]&&keyController.callback.has){keyController.callback.has(i)}}if(WORLD.callback.update){WORLD.callback.update()}if(MAP&&MAP.data.callback){MAP.data.callback()}}function createObject(e,t){if(typeof e=="object"){t=e;e="Undefined"}var n=new _element(e);if(t){n.set(t)}return n}function createHud(e,t){if(typeof e=="object"){t=e;e=""}var n=new _hud(e);if(t){n.set(t)}return n}function cacheSprites(e,t){if(!t){t=e;e="data/sprites/"}else{e+="/"}for(var n in t){WORLD.sprites[t[n]]=new Image;WORLD.sprites[t[n]].src=e+t[n];WORLD.sprites[t[n]].onerror=function(){delete WORLD.sprites[t[n]]}}}function cacheSounds(e,t){if(!t){t=e;e="data/sounds/"}else{e+="/"}for(var n in t){WORLD.sounds[t[n]]=new Audio;WORLD.sounds[t[n]].src=e+t[n];WORLD.sounds[t[n]].onerror=function(){delete WORLD.sounds[t[n]]}}}function playSound(e){if(!WORLD.sounds[e]){return console.warn("Звук "+e+" не найден в кэше игры")}WORLD.sounds[e].load();WORLD.sounds[e].play()}function onUpdate(e){WORLD.callback.update=e}function createMap(e){MAP=createObject("Map",{size:[WORLD.element.width,WORLD.element.height],sprite:e,position:[WORLD.element.width/2,WORLD.element.height/2]});MAP.data.sprite=e}function mapAnimate(e,t){if(!MAP){return}t=t<1?1:t>5?5:t;var n=[0,0],r=[],i=5;switch(e){case"left":n=[WORLD.element.width+(WORLD.element.width/2-i),WORLD.element.height/2];r=[WORLD.element.width+WORLD.element.width/2,WORLD.element.height/2];break;case"right":n=[-(WORLD.element.width/2-i),WORLD.element.height/2];r=[-WORLD.element.width/2,WORLD.element.height/2];break;case"up":n=[WORLD.element.width/2,WORLD.element.height+(WORLD.element.height/2-i)];r=[WORLD.element.width/2,WORLD.element.height+WORLD.element.height/2];break;case"down":n=[WORLD.element.width/2,-(WORLD.element.height/2-i)];r=[WORLD.element.width/2,-WORLD.element.height/2];break;default:return console.warn("Указан неизвестный метод движения карты");break}MAP.set({speed:t});if(MAP.data.repeat){MAP.data.repeat.set({position:r,speed:t})}else{MAP.data.repeat=createObject("Map",{size:[WORLD.element.width,WORLD.element.height],sprite:MAP.data.sprite,position:r,speed:t})}MAP.data.callback=function(){MAP.move(e);MAP.data.repeat.move(e);if(!MAP.isVisible()){MAP.set({position:n})}if(!MAP.data.repeat.isVisible()){MAP.data.repeat.set({position:n})}}}function mapStop(){if(!MAP){return}delete MAP.data.callback}function _event(e){if(EVENTS[e]){return}this.name=name;this.callback=[];this.target=[];this.save={params:[],target:[]};EVENTS[e]=this}function onKeyHas(e){keyController.callback.has=e}function onKeyDown(e){keyController.callback.down=e}function onKeyUp(e){keyController.callback.up=e}function onClicked(e){keyController.callback.click=e}function onClickedObject(e){keyController.callback.clickObject=e}function __isGameKey(e){for(var t in KEYS){if(e==KEYS[t]){return true}}return false}function _hud(e){this.text=e||"";this.property={toggle:false,align:"left",color:"#fff",size:14,font:"Arial",bold:false,position:{left:5,top:20}};HUD[HUD.length]=this}window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||indow.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)}}();var OBJECTS=[];_element.prototype={destroy:function(){if(!this.has()){return}OBJECTS.splice(OBJECTS.indexOf(this),1);delete this.property;delete this.data},has:function(){for(var e in OBJECTS){if(OBJECTS[e]==this){return true}}return false},set:function(e){if(!this.has()){return}if(typeof e.size=="object"){this.property.size={width:e.size[0]||this.property.size.width,height:e.size[1]||this.property.size.height};this.property.polygons=[[0,0],[this.property.size.width,0],[this.property.size.width,this.property.size.height],[0,this.property.size.height]]}if(typeof e.polygons=="object"){if(e.polygons.length<3){console.warn("Количество полигонов не может быть меньше трех")}else{this.property.polygons=e.polygons;for(var t=0;t<e.polygons.length;++t){this.property.size.width=this.property.size.width<e.polygons[t][0]?e.polygons[t][0]:this.property.size.width;this.property.size.height=this.property.size.height<e.polygons[t][1]?e.polygons[t][1]:this.property.size.height}}}if(typeof e.sprite=="string"){if(!WORLD.sprites[e.sprite]){console.warn("Спрайт "+e.sprite+" не найден в кэше игры")}else{this.property.sprite=WORLD.sprites[e.sprite]}}if(typeof e.collision=="boolean"){this.property.collision=e.collision}if(typeof e.attach=="boolean"){this.property.attach=e.attach}if(typeof e.health=="number"){var n=this.property.health;this.property.health=e.health;if(this.property.health<=0){this.property.health=0;if(n>0){EVENTS["death"].call(this,{object:this})}}}if(typeof e.speed=="number"){this.property.speed=e.speed<1?1:e.speed>5?5:e.speed}if(typeof e.position=="object"){e.position[0]=typeof e.position[0]=="number"?e.position[0]:this.property.position.left;e.position[1]=typeof e.position[1]=="number"?e.position[1]:this.property.position.top;if(this.name!="Map"){var r=__getObjectOffset(this,{left:e.position[0],top:e.position[1]});if((r.left.min<0||r.left.max>WORLD.element.width||r.top.min<0||r.top.max>WORLD.element.height)&&this.property.attach){return this}if(__isObjectCollision(this,{left:e.position[0],top:e.position[1]})){return this}if(!this.has()){return}}this.property.position={left:e.position[0],top:e.position[1]}}return this},get:function(e){return this.property[e]},isVisible:function(){if(!this.has()){return false}var e=__getObjectOffset(this);return!(e.left.max<0||e.left.min>WORLD.element.width||e.top.max<0||e.top.min>WORLD.element.height)},giveDamage:function(e,t){if(!this.has()){return}if(this.property.health<=0){return this}if(!t){t=e;e=null}this.property.health-=t;if(this.property.health<=0){this.property.health=0;EVENTS["death"].call(this,{object:this,forward:e})}return this},specifyPlayer:function(){if(!this.has()){return}WORLD.player=this;return this},setData:function(e,t){if(!this.has()){return}if(typeof t=="undefined"){delete this.property.data[e]}else{this.property.data[e]=t}return this},getData:function(e){if(!this.has()){return}return this.property.data[e]},move:function(e){if(!this.has()){return}var t={_left:this.property.position.left,_top:this.property.position.top};switch(e){case"left":t._left-=this.property.speed;break;case"right":t._left+=this.property.speed;break;case"up":t._top-=this.property.speed;break;case"down":t._top+=this.property.speed;break;default:console.warn("Указан неизвестный метод движения");return this;break}this.set({position:[t._left,t._top]});if(this.name!="Map"){EVENTS["move"].call(this,{object:this,position:{left:t._left,top:t._top}})}return this}};var WORLD={canvas:null,element:null,sounds:[],sprites:[],player:null,callback:{update:null,map:null}};var MAP=null;var EVENTS=[];_event.prototype={addCallback:function(e,t){var n=this.callback.length;if(!t){this.callback[n]=e}else{this.target[n]=e;this.callback[n]=t}for(var r in this.save.target){this.call(this.save.target[r],this.save.params[r]);delete this.save.target[r];delete this.save.params[r]}},call:function(e,t){if(!this.callback.length){var n=this.save.target.length;this.save.target[n]=e;this.save.params[n]=t;return}for(var r in this.callback){if(this.target[r]===e||this.target[r]===e.name||!this.target[r]){this.callback[r](t)}}}};var eventList=["move","collision","death","enter","leave"];for(var i=0;i<eventList.length;++i){new _event(eventList[i])}delete eventList;var KEYS={TAB:9,ENTER:13,SHIFT:16,ALT:18,ESC:27,SPACE:32,CTRL:17,DOWN:83,UP:87,RIGHT:68,LEFT:65};var keyController={has:[],callback:{has:null,down:null,up:null,clickObject:null,click:null}};window.onkeydown=function(e){if(!__isGameKey(e.keyCode)||keyController.has[e.keyCode]){return}keyController.has[e.keyCode]=true;if(keyController.callback.down){keyController.callback.down(e.keyCode)}};window.onkeyup=function(e){if(!__isGameKey(e.keyCode)||!keyController.has[e.keyCode]){return}keyController.has[e.keyCode]=false;if(keyController.callback.up){keyController.callback.up(e.keyCode)}};window.onclick=function(e){if(keyController.callback.click){keyController.callback.click({position:{left:e.pageX,top:e.pageY}})}if(keyController.callback.clickObject){for(var t in OBJECTS){if(OBJECTS[t].name=="Map"){continue}if(__isPositionInObject({left:e.pageX,top:e.pageY},OBJECTS[t])){keyController.callback.clickObject({object:OBJECTS[t],position:{left:e.pageX,top:e.pageY}})}}}};var HUD=[];_hud.prototype={setText:function(e){this.text=e||"";return this},set:function(e){if(typeof e.color=="string"){this.property.color=e.color}if(typeof e.size=="number"){this.property.size=e.size}if(typeof e.font=="string"){this.property.font=e.font}if(typeof e.bold=="boolean"){this.property.bold=e.bold}if(typeof e.align=="string"){this.property.align=e.align}if(typeof e.position=="object"){this.property.position.left=e.position[0];this.property.position.top=e.position[1]}if(typeof e.toggle=="boolean"){this.property.toggle=e.toggle}return this},get:function(e){return this.property[e]},destroy:function(){HUD.splice(HUD.indexOf(this),1);delete this.text;delete this.property}}