/* uranEngine v1.4.1 / uranengine.ru */
function _element(e){this.name=e;this.id=(new Date).getTime();this.data={polygons:{points:[],size:{height:0,width:0}},collision:[],offset:{left:0,right:0,top:0,bottom:0},animate:{sprite:null,infinity:false,animated:false,getFrame:1,pause:5,update:0,frames:0},angle:0};this.property={fasten:false,sprite:null,health:100,collision:false,velocity:{x:2,y:2},polygons:[],position:{x:0,y:0},angle:0,size:{height:0,width:0},data:[]};OBJECTS.push(this)}function __isObjectCollision(e,t){var n=false;for(var r in OBJECTS){if(e==OBJECTS[r]){continue}if(__isPositionInObject(t,OBJECTS[r],e)){if(OBJECTS[r].property.collision){n=true}if(!e.data.collision[OBJECTS[r].id]){e.data.collision[OBJECTS[r].id]=true;if(!OBJECTS[r].property.collision){EVENTS["enter"].call(e,{object:e,actor:OBJECTS[r]})}if(e.has()&&OBJECTS[r].has()){EVENTS["collision"].call(e,{object:e,actor:OBJECTS[r]})}}}else{if(e.data.collision[OBJECTS[r].id]){delete e.data.collision[OBJECTS[r].id];if(!OBJECTS[r].property.collision){EVENTS["leave"].call(e,{object:e,actor:OBJECTS[r]})}}}if(!e.has()){return true}}return n}function __isPositionInObject(e,t,n){function s(e,t,n){for(var r=0;r<n.data.polygons.points.length-1;++r){var i=[n.data.offset.left+n.data.polygons.points[r][0],n.data.offset.top+n.data.polygons.points[r][1]],s=[n.data.offset.left+n.data.polygons.points[r+1][0],n.data.offset.top+n.data.polygons.points[r+1][1]];if((i[1]-s[1])*e[0]+(s[0]-i[0])*e[1]+(i[0]*s[1]-s[0]*i[1])==0||(i[1]-s[1])*t[0]+(s[0]-i[0])*t[1]+(i[0]*s[1]-s[0]*i[1])==0||((s[0]-i[0])*(e[1]-i[1])-(s[1]-i[1])*(e[0]-i[0]))*((s[0]-i[0])*(t[1]-i[1])-(s[1]-i[1])*(t[0]-i[0]))<0&&((t[0]-e[0])*(i[1]-e[1])-(t[1]-e[1])*(i[0]-e[0]))*((t[0]-e[0])*(s[1]-e[1])-(t[1]-e[1])*(s[0]-e[0]))<0){return true}}return false}var r=__getObjectPositionOffset(n,e);if(r.left>t.data.offset.right||r.right<t.data.offset.left||r.top>t.data.offset.bottom||r.bottom<t.data.offset.top){return false}for(var i=0;i<n.data.polygons.points.length-1;++i){if(__isPositionInPolygon(r.left+n.data.polygons.points[i][0],r.top+n.data.polygons.points[i][1],t)){return true}if(s([r.left+n.data.polygons.points[i][0],r.top+n.data.polygons.points[i][1]],[r.left+n.data.polygons.points[i+1][0],r.top+n.data.polygons.points[i+1][1]],t)){return true}}return false}function __isPositionInPolygon(e,t,n){var r=false,i=[],s=[];for(var o=0,u=n.data.polygons.points.length-1;o<n.data.polygons.points.length;u=o++){i=[n.data.offset.left+n.data.polygons.points[o][0],n.data.offset.left+n.data.polygons.points[u][0]];s=[n.data.offset.top+n.data.polygons.points[o][1],n.data.offset.top+n.data.polygons.points[u][1]];if(s[0]>t!=s[1]>t&&e<(i[1]-i[0])*(t-s[0])/(s[1]-s[0])+i[0]){r=!r}}return r}function __getObjectPositionOffset(e,t){return{left:t.x-e.property.size.width/2,right:t.x+e.property.size.width/2,top:t.y-e.property.size.height/2,bottom:t.y+e.property.size.height/2}}function __updateOffset(e){e.data.offset={left:e.property.position.x-e.property.size.width/2,right:e.property.position.x+e.property.size.width/2,top:e.property.position.y-e.property.size.height/2,bottom:e.property.position.y+e.property.size.height/2}}function __updatePolygons(e){var t=e.data.polygons.size.width/e.property.size.width,n=e.data.polygons.size.height/e.property.size.height;var r=Math.sin(e.data.angle),i=Math.cos(e.data.angle);for(var s in e.property.polygons){var o=e.property.polygons[s][0]/t-e.property.size.width/2,u=e.property.polygons[s][1]/n-e.property.size.height/2;e.data.polygons.points[s]=[e.property.size.width/2+(o*i-u*r),e.property.size.height/2+(o*r+u*i)]}e.data.polygons.points[e.property.polygons.length]=e.data.polygons.points[0]}function onDeath(e,t){EVENTS["death"].addCallback(e,t)}function onCollision(e,t){EVENTS["collision"].addCallback(e,t)}function onMove(e,t){EVENTS["move"].addCallback(e,t)}function onEnter(e,t){EVENTS["enter"].addCallback(e,t)}function onLeave(e,t){EVENTS["leave"].addCallback(e,t)}function onUpdate(e,t){EVENTS["update"].addCallback(e,t)}function onClicked(e,t){EVENTS["clicked"].addCallback(e,t)}function createWorld(e,t,n){window.onload=function(){WORLD.element=document.getElementById(e);if(!WORLD.element){return console.error("Canvas с id `"+e+"` не найден")}WORLD.canvas=WORLD.element.getContext("2d");WORLD.element.width=t[0];WORLD.element.height=t[1];WORLD.canvas.textBaseline="middle";WORLD.canvas.lineWidth=2;WORLD.canvas.strokeStyle="#ff0000";(function r(){requestAnimFrame(r);__updateWorld()})();n()}}function createObject(e,t){if(typeof e=="object"){t=e;e="Undefined"}var n=new _element(e);if(t){n.set(t)}return n}function createHud(e,t){if(typeof e=="object"){t=e;e=""}var n=new _hud(e);if(t){n.set(t)}return n}function cacheSprites(e,t){if(!t){t=e;e="data/sprites/"}else{e+="/"}for(var n in t){WORLD.sprites[t[n]]=new Image;WORLD.sprites[t[n]].src=e+t[n];WORLD.sprites[t[n]].onerror=function(){delete WORLD.sprites[t[n]]}}}function cacheSounds(e,t){if(!t){t=e;e="data/sounds/"}else{e+="/"}for(var n in t){WORLD.sounds[t[n]]=new Audio;WORLD.sounds[t[n]].src=e+t[n];WORLD.sounds[t[n]].onerror=function(){delete WORLD.sounds[t[n]]}}}function playSound(e){if(!WORLD.sounds[e]){return console.warn("Звук "+e+" не найден в кэше игры")}WORLD.sounds[e].load();WORLD.sounds[e].play()}function drawMap(e){if(!WORLD.sprites[e]){console.warn("Спрайт "+e+" не найден в кэше игры");return}WORLD.map={sprite:WORLD.sprites[e],position:[[0,0]]};WORLD.map.update=function(){for(var e=0;e<2;++e){if(WORLD.map.position[e]){WORLD.canvas.drawImage(WORLD.map.sprite,0,0,WORLD.element.width-WORLD.map.position[e][0],WORLD.element.height-WORLD.map.position[e][1],WORLD.map.position[e][0],WORLD.map.position[e][1],WORLD.element.width-WORLD.map.position[e][0],WORLD.element.height-WORLD.map.position[e][1])}}}}function moveMap(e,t){if(!WORLD.map){return}if(!WORLD.map.position[1]){if(e==180){WORLD.map.position[1]=[WORLD.element.width,0]}else if(e==0){WORLD.map.position[1]=[-WORLD.element.width,0]}else if(e==90){WORLD.map.position[1]=[0,WORLD.element.height]}else if(e==270){WORLD.map.position[1]=[0,-WORLD.element.height]}else{console.warn("");return}}var n=Math.sin(e*-CONST.RAD),r=Math.cos(e*-CONST.RAD);for(var i=0;i<2;++i){WORLD.map.position[i][0]+=t*r;WORLD.map.position[i][1]+=t*n}for(var i=0;i<2;++i){if(WORLD.map.position[i][0]+WORLD.element.width<=0){WORLD.map.position[i][0]=WORLD.element.width}if(WORLD.map.position[i][0]>=WORLD.element.width){WORLD.map.position[i][0]=-WORLD.element.width}if(WORLD.map.position[i][1]+WORLD.element.height<=0){WORLD.map.position[i][1]=WORLD.element.height}if(WORLD.map.position[i][1]>=WORLD.element.height){WORLD.map.position[i][1]=-WORLD.element.height}}}function __updateWorld(){WORLD.canvas.clearRect(0,0,WORLD.element.width,WORLD.element.height);if(WORLD.map){WORLD.map.update()}WORLD.canvas.beginPath();for(var e in OBJECTS){EVENTS["update"].call(OBJECTS[e],{object:OBJECTS[e]})}for(var e in OBJECTS){if(!OBJECTS[e].isVisible()||OBJECTS[e].property.size.width==0||OBJECTS[e].property.size.height==0){continue}WORLD.canvas.translate(OBJECTS[e].property.position.x,OBJECTS[e].property.position.y);WORLD.canvas.rotate(OBJECTS[e].data.angle);if(OBJECTS[e].data.animate.animated){WORLD.canvas.drawImage(OBJECTS[e].data.animate.sprite,OBJECTS[e].property.size.width*(OBJECTS[e].data.animate.getFrame-1),0,OBJECTS[e].data.animate.sprite.width/OBJECTS[e].data.animate.frames,OBJECTS[e].data.animate.sprite.height,-OBJECTS[e].property.size.width/2,-OBJECTS[e].property.size.height/2,OBJECTS[e].property.size.width,OBJECTS[e].property.size.height);OBJECTS[e].data.animate.update++;if(OBJECTS[e].data.animate.update==OBJECTS[e].data.animate.pause){if(OBJECTS[e].data.animate.getFrame==OBJECTS[e].data.animate.frames){if(OBJECTS[e].data.animate.infinity){OBJECTS[e].data.animate.getFrame=1}}else{OBJECTS[e].data.animate.getFrame++}OBJECTS[e].data.animate.update=0}}else if(OBJECTS[e].property.sprite){WORLD.canvas.drawImage(OBJECTS[e].property.sprite,-OBJECTS[e].property.size.width/2,-OBJECTS[e].property.size.height/2,OBJECTS[e].property.size.width,OBJECTS[e].property.size.height)}WORLD.canvas.rotate(-OBJECTS[e].data.angle);WORLD.canvas.translate(-OBJECTS[e].property.position.x,-OBJECTS[e].property.position.y);if(OBJECTS[e].data.polygons.points.length>2&&CONST.DEBUG){for(var t=0;t<OBJECTS[e].data.polygons.points.length-1;++t){WORLD.canvas.moveTo(OBJECTS[e].data.offset.left+OBJECTS[e].data.polygons.points[t][0],OBJECTS[e].data.offset.top+OBJECTS[e].data.polygons.points[t][1]);WORLD.canvas.lineTo(OBJECTS[e].data.offset.left+OBJECTS[e].data.polygons.points[t+1][0],OBJECTS[e].data.offset.top+OBJECTS[e].data.polygons.points[t+1][1])}}}WORLD.canvas.stroke();for(var e in HUD){if(!HUD[e].text.length||!HUD[e].property.toggle){continue}WORLD.canvas.textAlign=HUD[e].property.align;WORLD.canvas.fillStyle=HUD[e].property.color;WORLD.canvas.font=(HUD[e].property.bold?"bold ":"")+HUD[e].property.size+"px "+HUD[e].property.font;WORLD.canvas.fillText(HUD[e].text,HUD[e].property.position.x,HUD[e].property.position.y)}if(keyController.callback.has){for(var e in keyController.has){if(keyController.has[e]){keyController.callback.has(e)}}}if(WORLD.callback.update){WORLD.callback.update()}}function onWorldUpdate(e){WORLD.callback.update=e}function _event(e){if(EVENTS[e]){return}this.name=name;this.callback=[];this.target=[];this.save={params:[],target:[]};EVENTS[e]=this}function _hud(e){this.text=e||"";this.property={toggle:false,align:"left",color:"#fff",size:14,font:"Arial",bold:false,position:{x:5,y:20}};HUD.push(this)}function onKeyHas(e){keyController.callback.has=e}function onKeyDown(e){keyController.callback.down=e}function onKeyUp(e){keyController.callback.up=e}function onClicked(e){keyController.callback.click=e}function onMouseMove(e){keyController.callback.move=e}function __isGameKey(e){for(var t in KEYS){if(e==KEYS[t]){return true}}return false}function random(e,t){return Math.round(e-.5+Math.random()*(t-e+1))}function vectorLength(e,t){return Math.sqrt(Math.pow((t.x||t[0])-(e.x||e[0]),2)+Math.pow((t.y||t[1])-(e.y||e[1]),2))}function anglePoint(e,t,n,r){var i=Math.atan2(t-r,n-e)*CONST.DEG;return i<0?i+360:i}function cloneArray(e){return e.slice()}function cloneObject(e){if(typeof e!="object"){return e}var t=new e.constructor;for(var n in e){t[n]=typeof e[i]=="object"?cloneObject(e[n]):e[n]}return t}var CONST={RAD:Math.PI/180,DEG:180/Math.PI,FRAMES:60,DEBUG:false};var OBJECTS=[];_element.prototype={destroy:function(){if(!this.has()){return}OBJECTS.splice(OBJECTS.indexOf(this),1);delete this.property;delete this.data},has:function(){for(var e in OBJECTS){if(OBJECTS[e]==this){return true}}return false},set:function(e){if(!this.has()){return}if(typeof e.size=="object"){this.property.size={width:typeof e.size.width=="number"?e.size.width:this.property.size.width,height:typeof e.size.height=="number"?e.size.height:this.property.size.height};__updateOffset(this);if(!this.property.polygons.length){this.data.polygons.size=this.property.size;this.property.polygons=[[0,0],[this.property.size.width,0],[this.property.size.width,this.property.size.height],[0,this.property.size.height]];this.data.polygons.points=cloneArray(this.property.polygons);this.data.polygons.points[this.property.polygons.length]=this.data.polygons.points[0]}else{__updatePolygons(this)}}if(typeof e.polygons=="object"){if(e.polygons.length<3){console.warn("Количество полигонов не может быть меньше трех")}else{this.data.polygons.size={width:0,height:0};for(var t in e.polygons){this.data.polygons.size={width:this.data.polygons.size.width<e.polygons[t][0]?e.polygons[t][0]:this.data.polygons.size.width,height:this.data.polygons.size.height<e.polygons[t][1]?e.polygons[t][1]:this.data.polygons.size.height}}this.property.polygons=cloneArray(e.polygons);this.data.polygons.points=cloneArray(e.polygons);this.data.polygons.points[this.property.polygons.length]=this.data.polygons.points[0];if(this.property.size.width==0&&this.property.size.height==0){this.property.size=this.data.polygons.size;__updateOffset(this)}__updatePolygons(this)}}if(typeof e.angle=="number"){if(e.angle>360){e.angle-=360}else if(e.angle<-360){e.angle+=360}this.data.angle=(this.property.angle=e.angle)*-CONST.RAD;__updatePolygons(this)}if(typeof e.sprite=="string"){if(!WORLD.sprites[e.sprite]){console.warn("Спрайт "+e.sprite+" не найден в кэше игры")}else{this.property.sprite=WORLD.sprites[e.sprite];this.data.animate.animated=false}}if(typeof e.collision=="boolean"){this.property.collision=e.collision}if(typeof e.fasten=="boolean"){this.property.fasten=e.fasten}if(typeof e.health=="number"){var n=this.property.health;this.property.health=e.health;if(this.property.health<=0){this.property.health=0;if(n>0){EVENTS["death"].call(this,{object:this})}}}if(typeof e.velocity=="object"){this.property.velocity={x:typeof e.velocity.x=="number"?e.velocity.x:this.property.velocity.x,y:typeof e.velocity.y=="number"?e.velocity.y:this.property.velocity.y}}else if(typeof e.velocity=="number"){this.property.velocity={x:e.velocity,y:e.velocity}}if(typeof e.position=="object"){var r={_x:typeof e.position.x=="number"?e.position.x:this.property.position.x,_y:typeof e.position.y=="number"?e.position.y:this.property.position.y};var i=__getObjectPositionOffset(this,{x:r._x,y:r._y});if(this.property.fasten){for(var t in this.data.polygons.points){if(i.left+this.data.polygons.points[t][0]<0||i.left+this.data.polygons.points[t][0]>WORLD.element.width||i.top+this.data.polygons.points[t][1]<0||i.top+this.data.polygons.points[t][1]>WORLD.element.height){return this}}}if(__isObjectCollision(this,{x:r._x,y:r._y})){return this}if(!this.has()){return}this.property.position={x:r._x,y:r._y};__updateOffset(this)}return this},get:function(e){return this.property[e]},isVisible:function(){if(!this.has()){return false}return!(this.data.offset.right<0||this.data.offset.left>WORLD.element.width||this.data.offset.bottom<0||this.data.offset.top>WORLD.element.height)},giveDamage:function(e,t){if(!this.has()){return}if(this.property.health<=0){return this}if(!t){t=e;e=null}this.property.health-=t;if(this.property.health<=0){this.property.health=0;EVENTS["death"].call(this,{object:this,actor:e})}return this},specifyPlayer:function(){if(!this.has()){return}WORLD.player=this;return this},setData:function(e,t){if(!this.has()){return}if(typeof t=="undefined"){delete this.property.data[e]}else{this.property.data[e]=t}return this},getData:function(e){if(!this.has()){return}return this.property.data[e]},animate:function(e,t,n,r){if(!WORLD.sprites[e]){console.warn("Спрайт "+e+" не найден в кэше игры")}else{this.data.animate={sprite:WORLD.sprites[e],infinity:typeof n=="boolean"?n:r,animated:true,getFrame:1,pause:typeof n=="number"?n:this.data.animate.pause,update:0,frames:t}}return this},move:function(e){if(!this.has()){return}var t={x:this.property.position.x+this.property.velocity.x*Math.cos(e*-CONST.RAD),y:this.property.position.y+this.property.velocity.y*Math.sin(e*-CONST.RAD)};this.set({position:t});EVENTS["move"].call(this,{object:this,position:t});return this},moveTo:function(e,t){if(!this.has()){return}this.move(anglePoint(this.property.position.x,this.property.position.y,e,t));return this}};var WORLD={canvas:null,element:null,sounds:[],sprites:[],map:null,player:null,callback:{update:null,map:null}};var EVENTS=[];_event.prototype={addCallback:function(e,t){var n=this.callback.length;if(!t){this.callback[n]=e}else{this.target[n]=e;this.callback[n]=t}for(var r in this.save.target){this.call(this.save.target[r],this.save.params[r]);delete this.save.target[r];delete this.save.params[r]}},call:function(e,t){if(!this.callback.length){var n=this.save.target.length;this.save.target[n]=e;this.save.params[n]=t;return}for(var r in this.callback){if(this.target[r]===e||this.target[r]===e.name||!this.target[r]){this.callback[r](t)}}}};var EVENT_LIST=["move","collision","death","enter","leave","update","clicked"];for(var i in EVENT_LIST){new _event(EVENT_LIST[i])}var HUD=[];_hud.prototype={setText:function(e){this.text=e||"";return this},set:function(e){if(typeof e.color=="string"){this.property.color=e.color}if(typeof e.size=="number"){this.property.size=e.size}if(typeof e.font=="string"){this.property.font=e.font}if(typeof e.bold=="boolean"){this.property.bold=e.bold}if(typeof e.align=="string"){this.property.align=e.align}if(typeof e.position=="object"){this.property.position={x:typeof e.position.x=="number"?e.position.x:this.property.position.x,y:typeof e.position.y=="number"?e.position.y:this.property.position.y}}if(typeof e.toggle=="boolean"){this.property.toggle=e.toggle}return this},get:function(e){return this.property[e]},destroy:function(){HUD.splice(HUD.indexOf(this),1);delete this.text;delete this.property}};var KEYS={TAB:9,ENTER:13,SHIFT:16,ALT:18,ESC:27,SPACE:32,CTRL:17,DOWN:83,UP:87,RIGHT:68,LEFT:65};var keyController={has:[],callback:{has:null,down:null,up:null,click:null,move:null}};window.onmousemove=function(e){if(keyController.callback.move){keyController.callback.move({x:e.pageX,y:e.pageY})}};window.onkeydown=function(e){if(!__isGameKey(e.keyCode)||keyController.has[e.keyCode]){return}keyController.has[e.keyCode]=true;if(keyController.callback.down){keyController.callback.down(e.keyCode)}};window.onkeyup=function(e){if(!__isGameKey(e.keyCode)||!keyController.has[e.keyCode]){return}keyController.has[e.keyCode]=false;if(keyController.callback.up){keyController.callback.up(e.keyCode)}};window.onclick=function(e){if(keyController.callback.click){keyController.callback.click({position:{x:e.pageX,y:e.pageY}})}for(var t in OBJECTS){if(__isPositionInPolygon(e.pageX,e.pageY,OBJECTS[t])){EVENTS["clicked"].call(OBJECTS[t],{object:OBJECTS[t],position:{x:e.pageX,y:e.pageY}})}}};window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/CONST.FRAMES)}}()